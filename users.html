<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Library</title>
    <link rel="icon" href="book.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <style>
        table {
            font-family: arial, sans-serif;
            border-collapse: collapse;
            width: 100%;
        }

        td,
        th {
            border: 1px solid #dddddd;
            text-align: left;
            padding: 8px;
        }

        tr:nth-child(even) {
            background-color: #dddddd;
        }

        .tableContainer {
            overflow-x: auto;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 class="text-center mt-3 mb-3">Library</h1>
        <div class="card">
            <div class="card-header">Return home</div>
            <div class="card-body">
                <p id="signout-message"></p>
                <button class="btn btn-primary" onclick="window.location.href='/'">
                    Return home</button>
            </div>
        </div><br>
        <div class="card">
            <div class="card-header">All users:</div>
            <div class="card-body">
                <div class="tableContainer" id="users-table"></div>
            </div>
        </div><br>
        <div class="card">
            <div class="card-header">Source code</div>
            <div class="card-body"><a href="https://github.com/karolpeszek/library-client"
                    target="_blank"><label>Client</label></a><br><a href="https://github.com/karolpeszek/library-server"
                    target="_blank"><label>Server</label></a>
            </div>
        </div><br><br>
    </div>
    <script>
        function refresh() {
            let bookList = document.getElementById('users-table');
            fetch('https://library.karol.gay/users/get').then((response) => response.json()).then((data) => {
                console.log(data);
                let html = '<table><tr><td>UUID</td><td>Name</td><td>e-mail</td></tr>'
                for (let it = 0; it < data.length; it++)
                    html += '<tr><td>' + data[it].uuid + '</td><td>' + data[it].name + '</td><td>' + data[it].email + '</td></tr>';

                html += '</table>';
                bookList.innerHTML = html;

            }).catch((err) => {

                console.log(err);
            });
        }
        refresh();
    </script>
    <script>
        let counter = 0;
        function reconnect() {
            if (counter > 10) return;
            counter++;
            let ws = new WebSocket('wss://library.karol.gay/updates');

            ws.addEventListener("open", () => {
                console.log('connected')
            })
            ws.addEventListener("message", message => {
                console.log(message.data);

                if (message.data == "UPDATE") refresh();
            });
            ws.addEventListener("close", () => {
                reconnect();
            });
            ws.addEventListener("error", error => {
                console.log(error);
                reconnect();
            })
        }
        reconnect();
    </script>
</body>

</html>