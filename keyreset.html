<html>

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <title>Library - reset Passkey</title>
        <link rel="icon" href="book.png">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://getbootstrap.com/docs/5.3/assets/css/docs.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
        <style>
            @media(prefers-color-scheme:dark) {

                .form-select,
                .form-control,
                .form-control:focus {
                    background-color: #343a40;
                    height: auto;
                }
            }
        </style>
    </head>

    <body>
        <div class="container">
            <h1 class="text-center mt-3 mb-3">Library</h1>

            <div class="card">
                <div class="card-header">
                    Reset Passkey
                </div>
                <div class="card-body">
                    <p>Here you can pick a name that will be displayed on your
                        Passkey. You can leave it empty, but it's not
                        recommended. Also note, that after you register a new
                        Passkey, your old one will stop working.</p>
                    <div class="form-floating mb-3">
                        <input type="email" class="form-control" id="passkey-name" placeholder="Jane Appleseed">
                        <label for="passkey-name">Passkey name</label>
                    </div>
                    <div class="mb-3">
                        <input class="form-check-input" type="checkbox" value="" id="user-confirm">
                        <label class="form-check-label" for="user-confirm" id="user-confirm-label">
                        </label>
                    </div>
                    <button class="btn btn-primary" onclick="resetKey()">
                        Register new Passkey</button>

                </div>
            </div>
            <br>
            <div class="card">
                <div class="card-header">Notice</div>
                <div class="card-body">
                    <p>This site does not use passwords. Instead it uses
                        Passkeys. A passkey is a unique code or token that is used to access a website or service
                        instead of a password. The user is
                        issued a passkey when they sign up for the service, and they can use it to sign in instead of a
                        password. Passkeys are
                        often generated by a device or app, and the user must have access to that device or app in order
                        to sign in. If you want to learn more about Passkeys
                        clieck <a href="https://www.youtube.com/watch?v=zJPNuORkvvk" target="_blank">here</a>.</p>
                </div>


            </div><br>
            <div class="card">
                <div class="card-header">Source code</div>
                <div class="card-body"><a href="https://github.com/karolpeszek/library-client"
                        target="_blank"><label>Client</label></a><br><a
                        href="https://github.com/karolpeszek/library-server" target="_blank"><label>Server</label></a>
                </div>
            </div><br><br>
        </div>
        <script>
            function parseJwt(token) {
                var base64Url = token.split('.')[1];
                var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function (c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));

                return JSON.parse(jsonPayload);
            }
            let decodedResetToken = null, resetToken = null;
            try {
                resetToken = new URLSearchParams(window.location.search).get('token');
                decodedResetToken = parseJwt(resetToken);
                document.getElementById('user-confirm-label').innerHTML = 'I aknowledge that I am the owner of email address ' + decodedResetToken.mail + '.';
            } catch (err) {
                window.alert('This token is invalid. You can request a new one. Error:', err);
                window.location.href = '/lostdevice.html';
            }
            async function resetKey() {
                let userConfirmed = document.getElementById('user-confirm').checked;
                if (!userConfirmed) {
                    window.alert('Make sure you checked the acknowledgement.');
                    return;
                }
                try {
                    let nameBoxText = document.getElementById('passkey-name').value || decodedResetToken.mail;
                    const publicKeyCredentialCreationOptions = {
                        challenge: Uint8Array.from(
                            decodedResetToken.nonce, c => c.charCodeAt(0)),
                        rp: {
                            name: "Library",
                            id: "library.karol.gay",
                            icon: "https://library.karol.gay/book.png"
                        },
                        user: {
                            id: Uint8Array.from(
                                decodedResetToken.uuid, c => c.charCodeAt(0)),
                            name: decodedResetToken.mail,
                            displayName: nameBoxText,
                        },
                        pubKeyCredParams: [{ alg: -7, type: "public-key" }],
                        authenticatorSelection: {
                            requireResidentKey: true,
                            authenticatorAttachment: 'cross-platform',
                            userVerification: 'required'
                        },
                        timeout: 360000,
                        attestation: 'none'
                    };


                    navigator.credentials.create({
                        publicKey: publicKeyCredentialCreationOptions
                    }).then(async credential => {
                        const registrationObject = {
                            resetToken: resetToken,
                            publicKey: btoa(String.fromCharCode.apply(null, new Uint8Array(credential.response.getPublicKey()))),
                            keyId: credential.id,
                            clientDataJson: JSON.parse(new TextDecoder().decode(credential.response.clientDataJSON)),
                            userName: nameBoxText
                        };
                        console.log(registrationObject);
                        fetch('https://library.karol.gay/registerKey', {
                            method: 'POST', // *GET, POST, PUT, DELETE, etc.
                            body: JSON.stringify(registrationObject) // body data type must match "Content-Type" header
                        }).then(response => {
                            console.log(response);

                            if (response.ok) {
                                window.alert('New key registered!');
                                window.location.href = '/';
                            }
                            else {
                                window.alert('This link is invalid. You can request a new one.');
                                window.location.href = '/lostdevice.html';
                            }
                        })
                    }).catch(err => {
                        console.log(err);
                        window.alert('There was an unexpected error. Sorry for inconvenience. ' + err);
                    })
                } catch (err) {
                    window.alert('There was an unexpected error. Sorry for inconvenience. ' + err)
                }
            }
        </script>
        <script>
            window.matchMedia('(prefers-color-scheme: dark)')
                .addEventListener('change', ({ matches }) => {
                    if (matches) {
                        document.body.setAttribute('data-bs-theme', 'dark')
                    } else {
                        document.body.setAttribute('data-bs-theme', 'light')
                    }
                })
            if (window.matchMedia('(prefers-color-scheme: dark)').matches) document.body.setAttribute('data-bs-theme', 'dark')

        </script>
    </body>



</html>